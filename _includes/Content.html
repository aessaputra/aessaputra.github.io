<div class="content">
    {{ content | markdownify }}
</div>

<script>
    /**
     * Wiki Links Processor for Jekyll
     * 
     * Features:
     * - Converts [[wikilink]] syntax to clickable links
     * - Supports aliases: [[target|display text]]
     * - Supports external links: [[title::url]]
     * - Hover preview with debounce
     * - Recovers wikilinks from Kramdown table parsing
     * - XSS-safe DOM manipulation
     * 
     * @author Jekyll Garden
     * @version 2.0.0
     */
    (function () {
        'use strict';

        // ============================================
        // Configuration
        // ============================================
        const CONFIG = {
            hoverDelay: 200,
            previewOffset: 5,
            previewZIndex: 1000,
            staleClass: 'stale-link',
            wikiClass: 'wiki-link',
            previewClass: 'link-preview'
        };

        // ============================================
        // State
        // ============================================
        let hoverTimeout = null;
        let currentPreview = null;

        // ============================================
        // Note Data (generated by Jekyll)
        // ============================================
        const availableNotes = [
            {%- for note in site.notes -%}
        {
        title: "{{ note.title | escape }}",
            url: "{{ site.baseurl }}{{ note.url }}",
                excerpt: "{{ note.content | strip_html | normalize_whitespace | truncatewords: 20 | escape }}",
                    aliases: {{ note.aliases | jsonify }}
    } {%- unless forloop.last -%}, {%- endunless -%}
    {%- endfor -%}
    ];

    // ============================================
    // Utility Functions
    // ============================================

    const entityDecoder = document.createElement('textarea');

    function normalizeLinkTarget(text) {
        if (!text) return '';
        entityDecoder.innerHTML = text;
        return entityDecoder.value.trim().toLowerCase();
    }

    function getNoteAliases(note) {
        if (!note || !note.aliases) return [];
        if (Array.isArray(note.aliases)) return note.aliases;
        if (typeof note.aliases === 'string') return [note.aliases];
        return [];
    }

    function findNoteByTitle(title) {
        const normalized = normalizeLinkTarget(title);
        if (!normalized) return null;

        return availableNotes.find(note => {
            if (normalizeLinkTarget(note.title) === normalized) {
                return true;
            }
            return getNoteAliases(note).some(alias =>
                normalizeLinkTarget(alias) === normalized
            );
        });
    }

    function isInsideCodeBlock(element) {
        let parent = element;
        while (parent) {
            if (parent.tagName === 'CODE' ||
                parent.tagName === 'PRE' ||
                parent.classList?.contains('highlighter-rouge') ||
                parent.classList?.contains('highlight')) {
                return true;
            }
            parent = parent.parentElement;
        }
        return false;
    }

    // ============================================
    // Table Recovery (Kramdown Fix)
    // ============================================

    function collapseWikiAliasTable(table) {
        if (!table || table.tagName !== 'TABLE') return null;

        const rows = table.querySelectorAll('tr');
        if (rows.length !== 1) return null;

        const cells = rows[0].querySelectorAll('td');
        if (cells.length < 2) return null;

        const cellContents = Array.from(cells).map(cell => cell.textContent || '');

        const firstCell = cellContents[0];
        if (!firstCell.includes('[[')) return null;

        const reconstructed = cellContents.join('|');

        const openCount = (reconstructed.match(/\[\[/g) || []).length;
        const closeCount = (reconstructed.match(/\]\]/g) || []).length;

        if (openCount === 0 || openCount !== closeCount) return null;

        const textNode = document.createTextNode(reconstructed);
        table.parentNode.replaceChild(textNode, table);
        return textNode;
    }

    // ============================================
    // Link Creation
    // ============================================

    function createExternalLink(title, url) {
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = title;
        return link;
    }

    function createInternalLink(note, displayText) {
        const link = document.createElement('a');
        link.href = note.url;
        link.textContent = displayText;
        link.className = CONFIG.wikiClass;

        link.addEventListener('mouseenter', function () {
            clearTimeout(hoverTimeout);
            hoverTimeout = setTimeout(() => {
                showPreview(this, note.title, note.excerpt);
            }, CONFIG.hoverDelay);
        });

        link.addEventListener('mouseleave', function () {
            clearTimeout(hoverTimeout);
            hidePreview();
        });

        return link;
    }

    function createStaleLink(displayText, targetText) {
        const link = document.createElement('a');
        link.href = 'javascript:void(0)';
        link.textContent = displayText;
        link.className = CONFIG.staleClass;
        link.title = 'Note not found: ' + targetText;
        return link;
    }

    // ============================================
    // Preview Functions (XSS-safe)
    // ============================================

    function showPreview(link, title, excerpt) {
        hidePreview();

        const preview = document.createElement('div');
        preview.className = CONFIG.previewClass;

        const content = document.createElement('div');
        content.className = 'preview-content';

        const titleEl = document.createElement('strong');
        titleEl.textContent = title;

        const excerptEl = document.createElement('p');
        excerptEl.textContent = excerpt;

        content.appendChild(titleEl);
        content.appendChild(excerptEl);
        preview.appendChild(content);

        document.body.appendChild(preview);

        const rect = link.getBoundingClientRect();
        preview.style.position = 'fixed';
        preview.style.left = rect.left + 'px';
        preview.style.top = (rect.bottom + CONFIG.previewOffset) + 'px';
        preview.style.zIndex = CONFIG.previewZIndex;

        currentPreview = preview;
    }

    function hidePreview() {
        if (currentPreview) {
            currentPreview.remove();
            currentPreview = null;
        }
        const orphaned = document.querySelector('.' + CONFIG.previewClass);
        if (orphaned) orphaned.remove();
    }

    // ============================================
    // Main Processing
    // ============================================

    function processWikiLinks(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            if (isInsideCodeBlock(node.parentElement)) return;

            const text = node.textContent;
            const wikiLinkRegex = /\[\[([^\]]+)\]\]/g;
            let match;
            let lastIndex = 0;
            const fragments = [];

            while ((match = wikiLinkRegex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    fragments.push(document.createTextNode(text.slice(lastIndex, match.index)));
                }

                const linkText = match[1];
                const linkSpan = document.createElement('span');

                if (linkText.includes('::')) {
                    const [title, url] = linkText.split('::');
                    linkSpan.appendChild(createExternalLink(title.trim(), url.trim()));
                } else {
                    let targetText = linkText;
                    let displayText = linkText;

                    if (linkText.includes('|')) {
                        const pipeIndex = linkText.indexOf('|');
                        targetText = linkText.slice(0, pipeIndex).trim();
                        displayText = linkText.slice(pipeIndex + 1).trim() || targetText;
                    } else {
                        targetText = targetText.trim();
                        displayText = displayText.trim();
                    }

                    const foundNote = findNoteByTitle(targetText);

                    if (foundNote) {
                        linkSpan.appendChild(createInternalLink(foundNote, displayText));
                    } else {
                        linkSpan.appendChild(createStaleLink(displayText, targetText));
                    }
                }

                fragments.push(linkSpan);
                lastIndex = match.index + match[0].length;
            }

            if (lastIndex < text.length) {
                fragments.push(document.createTextNode(text.slice(lastIndex)));
            }

            if (fragments.length > 0) {
                const parent = node.parentNode;
                fragments.forEach(fragment => parent.insertBefore(fragment, node));
                parent.removeChild(node);
            }
        }
        else if (node.nodeType === Node.ELEMENT_NODE) {
            const children = Array.from(node.childNodes);
            children.forEach(child => {
                if (child.nodeType === Node.ELEMENT_NODE && child.tagName === 'TABLE') {
                    const collapsed = collapseWikiAliasTable(child);
                    if (collapsed) {
                        processWikiLinks(collapsed);
                        return;
                    }
                }
                processWikiLinks(child);
            });
        }
    }

    // ============================================
    // Initialization
    // ============================================

    document.addEventListener('DOMContentLoaded', function () {
        const contentDiv = document.querySelector('.content');
        if (contentDiv) {
            processWikiLinks(contentDiv);
        }
    });

}) ();
</script>